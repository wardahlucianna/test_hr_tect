@page
@namespace appglobal
@using appglobal.models
@model m_employeModel
@{
    string f = Request.Query["f"];
    test_hr_tect_model _context = new test_hr_tect_model(AppGlobal.get_db_option()); //simplifying context initializer by override
    var url = "http://localhost:40000" + AppGlobal.get_logo_FE();
}

@if (f == "base")
{
    @await Html.PartialAsync("../_template/crud_base_profil_dept.cshtml")
}
else if (f == "table")
{
    <div class="row" id="table_content">
        <div class="col-md-12 grid-margin">
            <div class="d-flex justify-content-between flex-wrap">
                <div class="content-wrapper">
                    <div class="row">
                        <div class="col-md-12 grid-margin">

                            <div class="card mt-3">
                                <div class="card-body">
                                    <h4 class="mb-4 card-title">Data Employe</h4>
                                    @{
                                        WriteLiteral(crud_base_profil_dept.get_custom_button("Add", "", "btn btn-primary btn-fw", "btn_add()", "<i class='fa fa-plus'></i>"));
                                    }

                                    <div style="overflow-x:auto">
                                        <table class='table table-xs table-condensed table-bordered table-striped' style="width:100%;" id="table_admin">
                                            <thead>
                                                <tr>
                                                    <th style='width:10%;'>No</th>
                                                    <th style='width:40%;'>Company</th>
                                                    <th style='width:40%;'>First Name</th>
                                                    <th style='width:30%;'>Last Name</th>
                                                    <th style='width:30%;'>Email</th>
                                                    <th style='width:30%;'>Phone</th>
                                                    <th style='width:30%;'>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="div_alert" style="display:none;width:400px">
    </div>


    <script>
        $("#table_content").append(token);

        var table_admin = $('#table_admin').DataTable({
            "bLengthChange": false,
            "paging": true,
            "autoWidth": true,
            columns: [
                {
                    "data": "m_employe_id", "width": "10%", "className": "aksi", "render": function (data, type, row, meta) {
                        no = meta.row + meta.settings._iDisplayStart + 1;
                        return no;
                    }
                },
                {
                    "data": "m_company_name", "width": "20%", "render": function (data, type, row, meta) {
                        return `<a type='button' onClick="return btn_company(` + row.m_company_id + `);">` + row.m_company_name+`</a>`;
                    }
                },
                {
                    "data": "m_employe_first_name", "width": "20%", "render": function (data, type, row, meta) {
                        return data;
                    }
                },
                {
                    "data": "m_employe_last_name", "width": "20%", "render": function (data, type, row, meta) {
                        return data;
                    }
                },
                {
                    "data": "m_employe_email", "width": "20%", "render": function (data, type, row, meta) {
                        return data;
                    }
                },
                {
                    "data": "m_employe_phone", "width": "20%", "render": function (data, type, row, meta) {

                        return data;
                    }
                },
                {
                    "data": "", "width": "30%", "className": "aksi", "render": function (data, type, row, meta) {
                        var data_edit = "<button type='button' class='btn btn-warning btn-sm mt-2 mr-1' onclick='btn_edit(" + row.m_employe_id + ")'> <i class='fa fa-edit'></i> Edit</button>";
                        var data_hapus = "<button type='button' class='btn btn-danger btn-sm mt-2 mr-1' onclick='btn_hapus(" + row.m_employe_id + ")'>  <i class='fa fa-trash'></i> Delete</button>";
                        return data_edit + data_hapus;
                    }
                },
            ],
            processing: true,
            serverSide: true,
            filter: true,
            orderMulti: false,
            ajax: function (data, callback, settings) {
                var index = data.order[0].column;
                var data_new = {};
                data_new.__RequestVerificationToken = antiforgerytoken();
                data_new.start = data.start;
                data_new.length = data.length;
                data_new.search = data.search["value"];
                data_new.order_by = data.order[0].dir;
                data_new.order_name = data.columns[index].data;
                var url_path = "";

                $.ajax({
                    url: path + "?f=get_table_admin",
                    type: 'post',
                    dataType: 'json',
                    data: data_new,
                })
                    .done(function (result) {
                        if (result.status == true) {
                            var all_item = result.data[0];
                            var total_row = all_item.totalRow;
                            var totalFilter = all_item.totalFilter;
                            var item_lenght = all_item.data.length;

                            callback({
                                draw: data.draw,
                                data: all_item.data,
                                recordsTotal: total_row,
                                recordsFiltered: totalFilter,
                            });
                        }
                        else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Request Failed',
                                text: 'Sorry, proses loading data gagal \nMessage: ' + result.message,
                            })
                        }
                    }).fail(function (xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Request Failed',
                            text: 'Sorry, proses loading data gagal \nMessage: ' + result.message,
                        })
                    })
            },
        });
    </script>

    <script>
        function btn_edit(id) {
            $("#div_alert").load(path + "?f=view_edit&id=" + id, function (response, status, xhr) {
                if (status == "success") {
                    show_popup()
                }
                else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Failed',
                        text: msg + xhr.status + " " + xhr.statusText,
                    })
                }
            });
        }

        function btn_company(id) {
            $("#div_alert").load(path + "?f=view_company&id=" + id, function (response, status, xhr) {
                if (status == "success") {
                    show_popup_view()
                }
                else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Failed',
                        text: msg + xhr.status + " " + xhr.statusText,
                    })
                }
            });
        }


        function show_popup() {
            var formTemplate = $('#insert_area_content').clone()[0];

            (async () => {
                Swal.fire({
                    title: 'Edit Employe',
                    html: formTemplate,
                    showCancelButton: true,
                    focusConfirm: false,
                    confirmButtonText:
                        '<i class="fa fa-save"></i> Save',
                    cancelButtonText:
                        '<i class="fa fa-remove"></i> Close',
                    cancelButtonAriaLabel: 'Thumbs down',
                    onOpen: function () {
                        alert(1)
                    },
                    preConfirm: () => {
                        const m_employe_id = Swal.getPopup().querySelector('#m_employe_id').value
                        const m_company_id = Swal.getPopup().querySelector('#m_company_id').value
                        const m_employe_first_name = Swal.getPopup().querySelector('#m_employe_first_name').value
                        const m_employe_last_name = Swal.getPopup().querySelector('#m_employe_last_name').value
                        const m_employe_email = Swal.getPopup().querySelector('#m_employe_email').value
                        const m_employe_phone = Swal.getPopup().querySelector('#m_employe_phone').value
                        var invalid = 0;

                        if (!m_company_id) {
                            Swal.showValidationMessage(`Please enter company`)
                            invalid++
                        }
                        else if (!m_employe_first_name) {
                            Swal.showValidationMessage(`Please enter first name`)
                            invalid++
                        }
                        else if (!m_employe_last_name) {
                            Swal.showValidationMessage(`Please enter last name`)
                            invalid++
                        }

                        else if (!m_employe_email) {
                            Swal.showValidationMessage(`Please enter email`)
                            invalid++
                        }

                        else if (!m_employe_phone) {
                            Swal.showValidationMessage(`Please enter phone`)
                            invalid++
                        }

                        else if (m_employe_email) {
                            var regex = /^([a-zA-Z0-9_.+-])+\@@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                            status_email = regex.test(m_employe_email);
                            if (!status_email) {
                                Swal.showValidationMessage(`Wrong email`)
                                invalid++
                            }
                        }

                        if (invalid == 0) {
                            var form = $('#insert_area_uraian_pekerjaan').get(0);
                            var form_data = new FormData(form);
                            form_data.append("m_employe_id", m_employe_id);
                            form_data.append("m_company_id", m_company_id);
                            form_data.append("m_employe_first_name", m_employe_first_name);
                            form_data.append("m_employe_last_name", m_employe_last_name);
                            form_data.append("m_employe_phone", m_employe_phone);
                            form_data.append("m_employe_email", m_employe_email);
                            form_data.append("__RequestVerificationToken", antiforgerytoken());

                            $.ajax({
                                url: path + '?f=edit_handler',
                                type: 'post',
                                dataType: 'json',
                                data: form_data,
                                contentType: false,
                                processData: false
                            }).done(function (result) {
                                if (result.status === false) {
                                    reload_table();
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Request Failed',
                                        text: result.message,
                                    })

                                }
                                else {
                                    reload_table();
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Request Sucsess',
                                        text: result.message,
                                    })

                                }
                            }).fail(function (xhr, status, error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Request Failed',
                                    text: 'Sorry, save failed \nMessage: ' + result.message,
                                })
                            }).always(function () {
                            });

                        }
                    }
                })
            })()
        }

        function show_popup_view() {
            var formTemplate = $('#insert_area_content').clone()[0];

            (async () => {
                Swal.fire({
                    title: 'Edit Employe',
                    html: formTemplate,
                    confirmButtonText:
                        '<i class="fa fa-remove"></i> Close',
                })
            })()
        }

        function send_edit_data() {
            invalid = validate_form("insert_area"); //trigger form validation

            if (invalid == 0) {
                var form = $('#insert_area').get(0);
                var form_data = new FormData(form);

                $.ajax({
                    url: path + '?f=insert_handler',
                    type: 'post',
                    dataType: 'json',
                    data: form_data,
                    contentType: false,
                    processData: false
                }).done(function (result) {
                    if (result.status === false) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Request Failed',
                            text: result.message,
                        })
                    }
                    else {
                        reload_table();
                        Swal.fire({
                            icon: 'success',
                            title: 'Request Sucsess',
                            text: result.message,
                        })
                    }
                }).fail(function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Failed',
                        text: 'Sorry, save failed \nMessage: ' + result.message,
                    })
                }).always(function () {
                });
            }
        }

        function btn_add() {
            $("#form_area_content").load(path + "?f=view_add", function (response, status, xhr) {
                if (status == "success") {
                    $("#insert_area").append(token);
                }
                else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Failed',
                        text: msg + xhr.status + " " + xhr.statusText,
                    })
                }
            });
        }

        function btn_hapus(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    detele_kode_fungsi_ajax(id)
                }
            })
        }

        function detele_kode_fungsi_ajax(id) {
            url = path + "?f=delete_handler&id=" + id;
            ajax_json_request(url, null, delete_succeded, failed_delete);
        }

        function delete_succeded(result) {
            Swal.fire('Request Sucsess', result.message, 'success')
            reload_table()
        }

        function failed_delete(result) {
            Swal.fire('Request Failed', result.message, 'success')
            reload_table()
        }
    </script>
}
else if (f == "view_company")
{
    var m_company_id = String.IsNullOrEmpty(Request.Query["id"]) ? 0 : Convert.ToInt32(Request.Query["id"]);
    var company_data = _context.m_company.SingleOrDefault(e => e.m_company_id == m_company_id);

    <form class="form form-horizontal" id="insert_area_content" style="width:400px">
        @{
            var input =
                crud_base_profil_dept.get_input("m_company_id", "hidden", company_data.m_company_id.ToString()) +
                crud_base_profil_dept.get_input_group("Name", "m_company_name", company_data.m_company_name, "text", true, true, "100") +
                crud_base_profil_dept.get_input_group("Email", "m_company_email", company_data.m_company_email, "text", true, true, "100") +
                crud_base_profil_dept.get_input_group("Website", "m_company_website", company_data.m_company_website, "url", true, true, "100") +
                "<img style='width: 200px;height: auto;border-radius: 0%;' src='"+url+ company_data.m_company_logo +"'>";
            WriteLiteral(input);
        }

    </form>
}
else if (f == "view_edit")
{
    var m_employe_id = String.IsNullOrEmpty(Request.Query["id"]) ? 0 : Convert.ToInt32(Request.Query["id"]);
    <form class="form form-horizontal" id="insert_area_content" style="width:400px">
        @{
            var company_data = _context.m_company.ToList();
            var employee_data = (from a in _context.m_employe
                                 from b in _context.m_company
                                 where a.m_company_id == b.m_company_id && a.m_employe_id == m_employe_id
                                 select new
                                 {
                                     a.m_employe_first_name,
                                     a.m_employe_last_name,
                                     a.m_employe_phone,
                                     a.m_employe_email,
                                     b.m_company_id,
                                     a.m_employe_id,
                                     b.m_company_name
                                 }).SingleOrDefault();


            var input =
            crud_base_profil_dept.get_input("m_employe_id", "hidden", employee_data.m_employe_id.ToString()) +
            crud_base_profil_dept.get_select2_group("Company", "m_company_id", true, company_data, employee_data.m_company_id.ToString(), false, false, false) +
            crud_base_profil_dept.get_input_group("First Name", "m_employe_first_name", employee_data.m_employe_first_name, "text", true, false, "100") +
            crud_base_profil_dept.get_input_group("Last Name", "m_employe_last_name", employee_data.m_employe_last_name, "text", true, false, "100") +
            crud_base_profil_dept.get_input_group("Email", "m_employe_email", employee_data.m_employe_email, "email", true, false, "100") +
            crud_base_profil_dept.get_input_group("Phone", "m_employe_phone", employee_data.m_employe_phone, "number", true, false, "100");
            WriteLiteral(input);
        }

    </form>
}
else if (f == "view_add")
{
    var company_data = _context.m_company.ToList();
    <div class="row">
        <div class="col-md-12 grid-margin">
            <div class="d-flex justify-content-between flex-wrap">
                <div class="content-wrapper">
                    <div class="row">
                        <div class="col-md-12 grid-margin">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Tambah Kode Bagian</h4>
                                    <form class="form form-horizontal" id="insert_area">
                                        <div class="card mt-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        @{
                                                            var input =
                                                                crud_base_profil_dept.get_select2_group("Company", "m_company_id", true, company_data) +
                                                                crud_base_profil_dept.get_input_group("First Name", "m_employe_first_name", "", "text", true, false, "100") +
                                                                crud_base_profil_dept.get_input_group("Last Name", "m_employe_last_name", "", "text", true, false, "100") +
                                                                crud_base_profil_dept.get_input_group("Email", "m_employe_email", "", "email", true, false, "100") +
                                                                crud_base_profil_dept.get_input_group("Phone", "m_employe_phone", "", "number", true, false, "100");

                                                            WriteLiteral(input);
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            @{
                                                WriteLiteral(crud_base_profil_dept.get_custom_button("Save", "", "btn btn-success btn-fw", "send_add_data()", "<i class='fa fa-save'></i>"));
                                                WriteLiteral(crud_base_profil_dept.get_custom_button("Back", "", "btn btn-primary btn-fw", "btn_back()", "<i class='fa fa-arrow-left'></i>"));
                                            }
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function send_add_data() {
            invalid = validate_form("insert_area"); //trigger form validation

            if (invalid == 0) {
                var form = $('#insert_area').get(0);
                var form_data = new FormData(form);

                $.ajax({
                    url: path + '?f=insert_handler',
                    type: 'post',
                    dataType: 'json',
                    data: form_data,
                    contentType: false,
                    processData: false
                }).done(function (result) {
                    if (result.status === false) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Request Failed',
                            text: result.message,
                        })
                    }
                    else {
                        reload_table();
                        Swal.fire({
                            icon: 'success',
                            title: 'Request Sucsess',
                            text: result.message,
                        })
                    }
                }).fail(function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Request Failed',
                        text: 'Sorry, save failed \nMessage: ' + result.message,
                    })
                }).always(function () {
                });
            }
        }
    </script>
}

<script>
    function reload_table(m_profil_departemen_id, t_stake_holder_analysis_id) {
        $("#form_area_content").load(path + "?f=table", function (response, status, xhr) {
            if (status == "success") {
            }
            else {
                Swal.fire({
                    icon: 'error',
                    title: 'Request Failed',
                    text: msg + xhr.status + " " + xhr.statusText,
                })
            }
        });
    }

    function btn_back() {
        reload_table();
    }
</script>



